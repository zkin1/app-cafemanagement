<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Mi Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="profile-picture-container">
    <img [src]="profilePicture || 'assets/default-avatar.png'" 
    (error)="handleImageError($event)" 
    alt="Foto de perfil" 
    class="profile-picture">
    <ion-button (click)="takePicture()" expand="block" fill="outline">
      <ion-icon name="camera-outline" slot="start"></ion-icon>
      Cambiar foto
    </ion-button>
  </div>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="person-outline"></ion-icon>
        Información Personal
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form [formGroup]="perfilForm" (ngSubmit)="updatePerfil()">
        <ion-item>
          <ion-label position="stacked">Nombre</ion-label>
          <ion-input formControlName="name" type="text"></ion-input>
        </ion-item>
        <ion-text color="danger" *ngIf="perfilForm.get('name')?.hasError('required') && perfilForm.get('name')?.touched">
          El nombre es requerido
        </ion-text>
        <ion-text color="danger" *ngIf="perfilForm.get('name')?.hasError('minlength') && perfilForm.get('name')?.touched">
          El nombre debe tener al menos 3 caracteres
        </ion-text>

        <ion-item>
          <ion-label position="stacked">Email</ion-label>
          <ion-input formControlName="email" type="email"></ion-input>
        </ion-item>
        <ion-text color="danger" *ngIf="perfilForm.get('email')?.hasError('required') && perfilForm.get('email')?.touched">
          El email es requerido
        </ion-text>
        <ion-text color="danger" *ngIf="perfilForm.get('email')?.hasError('email') && perfilForm.get('email')?.touched">
          Por favor, ingrese un email válido
        </ion-text>

        <ion-item>
          <ion-label position="stacked">Rol</ion-label>
          <ion-input [value]="usuario.Role === 'admin' ? 'Administrador' : 'Empleado'" readonly></ion-input>
        </ion-item>

        <ion-button expand="block" type="submit" [disabled]="!perfilForm.valid">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Actualizar Perfil
        </ion-button>
      </form>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="lock-closed-outline"></ion-icon>
        Cambiar Contraseña
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form [formGroup]="passwordForm" (ngSubmit)="cambiarContrasena()">
        <ion-item>
          <ion-label position="stacked">Contraseña Actual</ion-label>
          <ion-input type="password" formControlName="contrasenaActual"></ion-input>
        </ion-item>
        <ion-text color="danger" *ngIf="passwordForm.get('contrasenaActual')?.hasError('required') && passwordForm.get('contrasenaActual')?.touched">
          La contraseña actual es requerida
        </ion-text>

        <ion-item>
          <ion-label position="stacked">Nueva Contraseña</ion-label>
          <ion-input type="password" formControlName="nuevaContrasena"></ion-input>
        </ion-item>
        <ion-text color="danger" *ngIf="passwordForm.get('nuevaContrasena')?.hasError('required') && passwordForm.get('nuevaContrasena')?.touched">
          La nueva contraseña es requerida
        </ion-text>
        <ion-text color="danger" *ngIf="passwordForm.get('nuevaContrasena')?.hasError('minlength') && passwordForm.get('nuevaContrasena')?.touched">
          La nueva contraseña debe tener al menos 8 caracteres
        </ion-text>
        <ion-text color="danger" *ngIf="passwordForm.get('nuevaContrasena')?.hasError('invalidPassword') && passwordForm.get('nuevaContrasena')?.touched">
          La contraseña debe contener al menos una letra mayúscula, una minúscula, un número y un carácter especial
        </ion-text>

        <ion-item>
          <ion-label position="stacked">Confirmar Nueva Contraseña</ion-label>
          <ion-input type="password" formControlName="confirmarContrasena"></ion-input>
        </ion-item>
        <ion-text color="danger" *ngIf="passwordForm.hasError('passwordMismatch') && passwordForm.get('confirmarContrasena')?.touched">
          Las contraseñas no coinciden
        </ion-text>

        <ion-button expand="block" type="submit" [disabled]="!passwordForm.valid">
          <ion-icon name="key-outline" slot="start"></ion-icon>
          Cambiar Contraseña
        </ion-button>
      </form>
    </ion-card-content>
  </ion-card>

  <ion-button expand="block" (click)="logout()" color="danger" class="logout-button">
    <ion-icon name="log-out-outline" slot="start"></ion-icon>
    Cerrar Sesión
  </ion-button>
</ion-content>

<ion-toast
  [isOpen]="showToast"
  [message]="toastMessage"
  [duration]="3000"
  position="top"
  [color]="toastColor">
</ion-toast>